<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Riwa-Wichteln</title>

  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@300;400;700;800&display=swap" rel="stylesheet">

  <style>
    html,body{
      height:100%;
      margin:0;
      font-family:"Nunito", system-ui, -apple-system, "Segoe UI", Roboto, Arial;
      background:#07142a;
      color:#0b1220;
    }
    .scene{
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .card{
      background:white;
      padding:24px;
      border-radius:12px;
      width:100%;
      max-width:700px;
      display:grid;
      grid-template-columns:1fr 260px;
      gap:20px;
    }
    @media(max-width:800px){
      .card{grid-template-columns:1fr;}
    }
  </style>
</head>

<body>
<div class="scene">
  <div class="card">

    <div>
      <h1>Wer bekommt dein Geschenk?</h1>

      <form id="giftForm">
        <label>Dein Name</label><br>
        <select id="memberSelect" required>
          <option value="">Bitte Namen auswählen …</option>
        </select><br><br>

        <label>Familien-Passwort</label><br>
        <input id="passwordInput" type="password" required><br><br>

        <button type="submit">Empfänger anzeigen</button>
        <button type="button" id="resetBtn">Zurücksetzen</button>
      </form>
    </div>

    <aside>
      <div id="resultEmpty">Hier erscheint der Empfänger.</div>
      <div id="resultCard" style="display:none;">
        <strong id="recipientName"></strong>
      </div>
    </aside>

  </div>
</div>

<script>
/* ================= DATA ================= */

const FAMILY_MEMBERS = [
  { name: "Emil", index: 0 },
  { name: "Anton", index: 0 },
  { name: "Juri", index: 1 },
  { name: "Ayla", index: 1 },
  { name: "Ottilia", index: 2 },
  { name: "Kleo", index: 2 },
  { name: "Dawson", index: 3 }
];

const FAMILY_PASSWORDS = {
  0: "schnee",
  1: "kerze",
  2: "stern",
  3: "christbaum"
};

/* ================= SETUP ================= */

const memberSelect = document.getElementById("memberSelect");
const form = document.getElementById("giftForm");
const passwordInput = document.getElementById("passwordInput");
const resultEmpty = document.getElementById("resultEmpty");
const resultCard = document.getElementById("resultCard");
const recipientNameEl = document.getElementById("recipientName");
const resetBtn = document.getElementById("resetBtn");

const SORTED_MEMBERS = FAMILY_MEMBERS.slice().sort((a,b)=>
  a.name.localeCompare(b.name)
);

SORTED_MEMBERS.forEach(m=>{
  const o=document.createElement("option");
  o.value=m.name;
  o.textContent=m.name;
  memberSelect.appendChild(o);
});

/* ================= RNG ================= */

function mulberry32(seed){
  let t = seed >>> 0;
  return function(){
    t += 0x6D2B79F5;
    let r = Math.imul(t ^ (t >>> 15), 1 | t);
    r ^= r + Math.imul(r ^ (r >>> 7), r | 61);
    return ((r ^ (r >>> 14)) >>> 0) / 4294967296;
  };
}

function shuffleArray(arr, rng){
  const a = arr.slice();
  for(let i=a.length-1;i>0;i--){
    const j=Math.floor(rng()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
  return a;
}

/* ================= ASSIGNMENT ================= */
/* no self, no same family, no A<->B */

function computeAssignment(){
  const year = new Date().getFullYear();
  const baseSeed = year >>> 0;
  const givers = SORTED_MEMBERS.slice();
  const N = givers.length;

  if (N <= 2) return null;

  const maxAttempts = 5000;

  for(let attempt=0; attempt<maxAttempts; attempt++){
    const rng = mulberry32(baseSeed + attempt*97);
    const receivers = shuffleArray(givers, rng);

    let mapping = {};
    let ok = true;

    for(let i=0;i<N;i++){
      const g=givers[i];
      const r=receivers[i];

      if(g.name===r.name || g.index===r.index){
        ok=false;
        break;
      }
      mapping[g.name]=r.name;
    }
    if(!ok) continue;

    // forbid reciprocal swaps
    for(const a in mapping){
      const b = mapping[a];
      if(mapping[b]===a){
        ok=false;
        break;
      }
    }
    if(ok) return mapping;
  }
  return null;
}

/* ================= FORM ================= */

form.addEventListener("submit", e=>{
  e.preventDefault();

  const name = memberSelect.value;
  const member = FAMILY_MEMBERS.find(m=>m.name===name);
  if(!member) return alert("Ungültiger Name");

  // ✅ CASE-INSENSITIVE PASSWORD CHECK
  const entered = passwordInput.value.trim().toLowerCase();
  const correct = (FAMILY_PASSWORDS[member.index] || "").toLowerCase();

  if(entered !== correct){
    return alert("Falsches Familien-Passwort");
  }

  const assignment = computeAssignment();
  if(!assignment) return alert("Keine gültige Zuteilung möglich");

  recipientNameEl.textContent = assignment[name];
  resultEmpty.style.display="none";
  resultCard.style.display="block";
});

resetBtn.addEventListener("click", ()=>{
  form.reset();
  resultEmpty.style.display="";
  resultCard.style.display="none";
});
</script>
</body>
</html>
